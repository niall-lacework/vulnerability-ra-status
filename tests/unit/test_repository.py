import os
import subprocess

import pytest

from vulnerability_ra_status import repository

@pytest.fixture(name='access_token')
def fixture_access_token():
    access_token = os.environ.get('GITHUB_ACCESS_TOKEN')
    if access_token is None:
        raise Exception('Github access token is not set')
    
    return access_token 

def test_can_get_repo_file_contents(access_token):
    repo = repository.GithubRepo(owner='lacework-dev', repo='helm3-platform',
                                 access_token=access_token)
    file_contents = repo.get_file_contents('config/prodn1/labels.yaml')

    assert file_contents is not None


def test_can_get_repo_commits(access_token):
    repo = repository.GithubRepo(owner='lacework-dev', repo='vuln-eval',
                                 access_token=access_token)
    commits = repo.get_commits()
    assert len(commits) > 0
    assert commits.get(
        '21f4837d9c45290d894ecefe2e2691e646fc80ba') == len(commits) - 1
